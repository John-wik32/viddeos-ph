<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Library CMS</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Custom scrollbar for better aesthetics */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
</head>
<body class="bg-gray-50 text-gray-800">
<div id="app"></div>

<script>
// --- Data & State Management ---

const DataManager = {
    // Wrapper to support both Window.storage (if available) and LocalStorage fallback
    async get(key) {
        try {
            if (window.storage) {
                const result = await window.storage.get(key);
                return result ? JSON.parse(result.value) : null;
            } else {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            }
        } catch (error) {
            console.error('Storage Get Error:', error);
            return null;
        }
    },
    
    async set(key, value) {
        try {
            const stringVal = JSON.stringify(value);
            if (window.storage) {
                await window.storage.set(key, stringVal);
            } else {
                localStorage.setItem(key, stringVal);
            }
            return true;
        } catch (error) {
            if (error.name === 'QuotaExceededError') {
                alert('Storage limit reached! Video/Image might be too large for this browser.');
            }
            console.error('Storage Set Error:', error);
            return false;
        }
    },
    
    async initialize() {
        const categories = await this.get('categories');
        const settings = await this.get('site-settings');
        const videos = await this.get('videos');
        
        if (!categories) {
            await this.set('categories', [
                {id: '1', name: 'Tutorials', color: '#3b82f6'},
                {id: '2', name: 'Reviews', color: '#10b981'},
                {id: '3', name: 'Entertainment', color: '#f59e0b'}
            ]);
        }
        if (!settings) {
            await this.set('site-settings', {title: 'Video Library', subtitle: 'Explore our collection', featuredCount: 3});
        }
        if (!videos) {
            await this.set('videos', []);
        }
    }
};

const State = {
    isAdmin: false,
    currentView: 'public',
    adminView: 'videos',
    videos: [],
    categories: [],
    tags: [],
    siteSettings: {},
    searchTerm: '',
    selectedCategory: 'all',
    selectedTag: 'all',
    sortBy: 'newest',
    
    async load() {
        this.videos = await DataManager.get('videos') || [];
        this.categories = await DataManager.get('categories') || [];
        this.tags = await DataManager.get('tags') || [];
        this.siteSettings = await DataManager.get('site-settings') || {title: 'Video Library', subtitle: 'Explore our collection', featuredCount: 3};
        this.updateAllTags();
    },
    
    updateAllTags() {
        const allTags = new Set();
        this.videos.forEach(v => {
            if (v.tags && Array.isArray(v.tags)) {
                v.tags.forEach(t => allTags.add(t));
            }
        });
        this.tags = [...allTags].sort();
        this.saveTags();
    },
    
    async saveVideos() { await DataManager.set('videos', this.videos); this.updateAllTags(); },
    async saveCategories() { await DataManager.set('categories', this.categories); },
    async saveTags() { await DataManager.set('tags', this.tags); },
    async saveSettings() { await DataManager.set('site-settings', this.siteSettings); },
    
    addVideo(video) {
        const newVideo = {...video, id: Date.now().toString(), views: 0, createdAt: new Date().toISOString()};
        this.videos.push(newVideo);
        this.saveVideos();
    },
    
    updateVideo(id, updates) {
        const index = this.videos.findIndex(v => v.id === id);
        if (index !== -1) {
            this.videos[index] = {...this.videos[index], ...updates};
            this.saveVideos();
        }
    },
    
    deleteVideo(id) {
        if (confirm('Delete this video?')) {
            this.videos = this.videos.filter(v => v.id !== id);
            this.saveVideos();
            UI.render();
        }
    },
    
    incrementViews(id) {
        const video = this.videos.find(v => v.id === id);
        if (video) {
            video.views = (video.views || 0) + 1;
            this.saveVideos();
        }
    },
    
    addCategory(category) {
        const newCategory = {...category, id: Date.now().toString()};
        this.categories.push(newCategory);
        this.saveCategories();
    },
    
    updateCategory(id, updates) {
        const index = this.categories.findIndex(c => c.id === id);
        if (index !== -1) {
            this.categories[index] = {...this.categories[index], ...updates};
            this.saveCategories();
        }
    },
    
    deleteCategory(id) {
        if (confirm('Delete this category?')) {
            this.categories = this.categories.filter(c => c.id !== id);
            this.saveCategories();
            UI.render();
        }
    },
    
    getFilteredVideos() {
        let filtered = [...this.videos];
        if (this.searchTerm) {
            const term = this.searchTerm.toLowerCase();
            filtered = filtered.filter(v => v.title.toLowerCase().includes(term) || (v.description && v.description.toLowerCase().includes(term)));
        }
        if (this.selectedCategory !== 'all') {
            filtered = filtered.filter(v => v.category === this.selectedCategory);
        }
        if (this.selectedTag !== 'all') {
            filtered = filtered.filter(v => v.tags && v.tags.includes(this.selectedTag));
        }
        filtered.sort((a, b) => {
            switch (this.sortBy) {
                case 'newest': return new Date(b.createdAt) - new Date(a.createdAt);
                case 'oldest': return new Date(a.createdAt) - new Date(b.createdAt);
                case 'mostViewed': return (b.views || 0) - (a.views || 0);
                default: return 0;
            }
        });
        return filtered;
    },
    
    getFeaturedVideos() {
        return this.videos.filter(v => v.featured).slice(0, this.siteSettings.featuredCount);
    },

    deleteAllVideos() {
        if (confirm('Delete ALL videos? This cannot be undone!')) {
            this.videos = [];
            this.saveVideos();
            UI.render();
        }
    },

    exportData() {
        const data = {videos: this.videos, categories: this.categories, tags: this.tags, siteSettings: this.siteSettings};
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `video-library-backup-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    },

    async importData(file) {
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            if (confirm('Import this data? Current data will be replaced!')) {
                this.videos = data.videos || [];
                this.categories = data.categories || [];
                this.tags = data.tags || [];
                this.siteSettings = data.siteSettings || this.siteSettings;
                await this.saveVideos();
                await this.saveCategories();
                await this.saveTags();
                await this.saveSettings();
                UI.render();
                alert('Data imported successfully!');
            }
        } catch (error) {
            alert('Error importing data: ' + error.message);
        }
    }
};

const FileHandler = {
    async fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },
    
    async handleVideoUpload(file) {
        if (!file.type.startsWith('video/')) {
            alert('Please select a video file');
            return null;
        }
        // Limit set to 30MB to give some buffer for LocalStorage, though >5MB often fails in standard LS.
        if (file.size > 30 * 1024 * 1024) {
            alert('Video file too large. Max 30MB. Consider using a URL instead.');
            return null;
        }
        try {
            const base64 = await this.fileToBase64(file);
            return base64;
        } catch (error) {
            alert('Error processing video');
            return null;
        }
    },
    
    async handleImageUpload(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return null;
        }
        if (file.size > 5 * 1024 * 1024) {
            alert('Image too large. Max 5MB.');
            return null;
        }
        try {
            const base64 = await this.fileToBase64(file);
            return base64;
        } catch (error) {
            alert('Error processing image');
            return null;
        }
    }
};

// --- UI Logic ---

const UI = {
    currentTags: [],
    uploadedVideoData: null,
    uploadedThumbnailData: null,
    
    render() {
        const app = document.getElementById('app');
        if (State.currentView === 'login') {
            app.innerHTML = this.renderLogin();
            this.attachLoginListeners();
        } else if (State.currentView === 'admin') {
            app.innerHTML = this.renderAdmin();
            this.attachAdminListeners();
        } else {
            app.innerHTML = this.renderPublic();
            this.attachPublicListeners();
        }
    },

    renderLogin() {
        return `<div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
                <h1 class="text-2xl font-bold mb-6 text-center">Admin Login</h1>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="adminPassword" class="w-full border rounded px-3 py-2" placeholder="Enter password" required>
                        <p class="text-xs text-gray-500 mt-1">Default: </p>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-medium">Login</button>
                    <button type="button" id="backToPublic" class="w-full bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 font-medium">Back to Site</button>
                </form>
            </div>
        </div>`;
    },

    renderPublic() {
        const featured = State.getFeaturedVideos();
        const filtered = State.getFilteredVideos();
        return `<div class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">${State.siteSettings.title}</h1>
                        <p class="text-gray-600 text-sm md:text-base">${State.siteSettings.subtitle}</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                         <input type="text" id="searchInput" class="w-full md:w-64 border rounded-lg px-4 py-2" placeholder="Search videos..." value="${State.searchTerm}">
                        <button id="adminLoginBtn" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-black text-sm font-medium whitespace-nowrap">Admin</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-3">
                <select id="categoryFilter" class="border rounded px-3 py-2 text-sm bg-gray-50">
                    <option value="all">All Categories</option>
                    ${State.categories.map(c => `<option value="${c.id}"${State.selectedCategory === c.id ? ' selected' : ''}>${c.name}</option>`).join('')}
                </select>
                <select id="tagFilter" class="border rounded px-3 py-2 text-sm bg-gray-50">
                    <option value="all">All Tags</option>
                    ${State.tags.map(t => `<option value="${t}"${State.selectedTag === t ? ' selected' : ''}>#${t}</option>`).join('')}
                </select>
                <select id="sortFilter" class="border rounded px-3 py-2 text-sm bg-gray-50 ml-auto">
                    <option value="newest"${State.sortBy === 'newest' ? ' selected' : ''}>Newest First</option>
                    <option value="oldest"${State.sortBy === 'oldest' ? ' selected' : ''}>Oldest First</option>
                    <option value="mostViewed"${State.sortBy === 'mostViewed' ? ' selected' : ''}>Most Viewed</option>
                </select>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 py-8">
            ${featured.length > 0 && State.searchTerm === '' && State.selectedCategory === 'all' && State.selectedTag === 'all' ? `
            <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><span class="text-yellow-500">‚≠ê</span> Featured Videos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${featured.map(v => this.renderVideoCard(v, false)).join('')}
                </div>
            </div>` : ''}
            
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                ${State.searchTerm ? 'üîç Search Results' : 'üìπ All Videos'} 
                <span class="text-gray-500 text-lg font-normal">(${filtered.length})</span>
            </h2>
            
            ${filtered.length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${filtered.map(v => this.renderVideoCard(v, false)).join('')}
            </div>` : '<div class="text-center py-16 text-gray-500 bg-white rounded-lg border border-dashed"><p class="text-4xl mb-2">üìπ</p><p>No videos found matching your criteria</p></div>'}
        </div>`;
    },

    renderAdmin() {
        return `<div class="bg-gray-900 text-white sticky top-0 z-20 shadow-md">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl font-bold flex items-center gap-2">üé¨ Admin Dashboard</h1>
                <button id="viewPublic" class="bg-blue-600 px-4 py-2 rounded text-sm hover:bg-blue-700 font-medium transition-colors">View Public Site</button>
            </div>
        </div>
        <div class="bg-white border-b shadow-sm overflow-x-auto">
            <div class="max-w-7xl mx-auto px-4 flex gap-1 min-w-max">
                <button class="px-4 py-3 font-medium border-b-2 transition-colors ${State.adminView === 'videos' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}" onclick="State.adminView='videos';UI.render()">Videos (${State.videos.length})</button>
                <button class="px-4 py-3 font-medium border-b-2 transition-colors ${State.adminView === 'categories' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}" onclick="State.adminView='categories';UI.render()">Categories (${State.categories.length})</button>
                <button class="px-4 py-3 font-medium border-b-2 transition-colors ${State.adminView === 'tags' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}" onclick="State.adminView='tags';UI.render()">Tags (${State.tags.length})</button>
                <button class="px-4 py-3 font-medium border-b-2 transition-colors ${State.adminView === 'settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}" onclick="State.adminView='settings';UI.render()">Settings</button>
                <button class="px-4 py-3 font-medium border-b-2 transition-colors ${State.adminView === 'tools' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-600 hover:text-gray-800'}" onclick="State.adminView='tools';UI.render()">Tools</button>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 py-8">
            ${State.adminView === 'videos' ? this.renderVideosAdmin() :
              State.adminView === 'categories' ? this.renderCategoriesAdmin() :
              State.adminView === 'tags' ? this.renderTagsAdmin() :
              State.adminView === 'tools' ? this.renderToolsAdmin() :
              this.renderSettingsAdmin()}
        </div>`;
    },

    renderVideosAdmin() {
        return `<div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Manage Videos</h2>
            <button onclick="UI.showVideoModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-medium flex items-center gap-2"><span>‚ûï</span> Add Video</button>
        </div>
        ${State.videos.length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            ${State.videos.map(v => this.renderVideoCard(v, true)).join('')}
        </div>` : '<div class="bg-white rounded-lg p-12 text-center border-2 border-dashed"><p class="text-gray-400 mb-4 text-4xl">üìπ</p><p class="text-gray-600 mb-4">No videos yet.</p><button onclick="UI.showVideoModal()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 font-medium">Add First Video</button></div>'}`;
    },

    renderCategoriesAdmin() {
        return `<div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Manage Categories</h2>
            <button onclick="UI.showCategoryModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-medium">‚ûï Add Category</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${State.categories.map(c => `<div class="bg-white rounded-lg p-4 shadow border hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full shadow-sm" style="background-color:${c.color}"></div>
                        <h3 class="font-bold text-lg">${c.name}</h3>
                    </div>
                    <div class="flex gap-2">
                        <button onclick='UI.showCategoryModal(${JSON.stringify(c).replace(/'/g, "&apos;")})' class="p-2 text-gray-500 hover:bg-gray-100 rounded">‚úèÔ∏è</button>
                        <button onclick="State.deleteCategory('${c.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded">üóëÔ∏è</button>
                    </div>
                </div>
                <p class="text-sm text-gray-600 pl-11">${State.videos.filter(v => v.category === c.id).length} videos linked</p>
            </div>`).join('')}
        </div>`;
    },

    renderTagsAdmin() {
        return `<div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">All Tags</h2>
            <p class="text-gray-600 text-sm">Tags are automatically created when you add them to videos.</p>
        </div>
        ${State.tags.length > 0 ? `<div class="bg-white rounded-lg p-6 shadow">
            <div class="flex flex-wrap gap-3">
                ${State.tags.map(t => {
                    const count = State.videos.filter(v => v.tags && v.tags.includes(t)).length;
                    return `<div class="bg-blue-50 px-4 py-2 rounded-full border border-blue-200 flex items-center gap-2">
                        <span class="font-medium text-blue-700">#${t}</span>
                        <span class="bg-blue-200 text-blue-800 text-xs px-2 py-0.5 rounded-full">${count}</span>
                    </div>`;
                }).join('')}
            </div>
        </div>` : '<div class="bg-white rounded-lg p-12 text-center text-gray-500">No tags yet. Add tags to your videos to see them here.</div>'}`;
    },

    renderToolsAdmin() {
        return `<div class="space-y-6 max-w-2xl">
            <div class="bg-white rounded-lg p-6 shadow border">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">üîÑ Backup & Restore</h3>
                <div class="space-y-4">
                    <button onclick="State.exportData()" class="w-full bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600 font-medium flex justify-center gap-2">
                        <span>üì•</span> Export All Data (JSON)
                    </button>
                    <div class="relative">
                        <label class="block w-full bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600 font-medium text-center cursor-pointer transition-colors">
                            <span>üì§</span> Import Data
                            <input type="file" accept=".json" onchange="UI.handleImport(event)" class="hidden">
                        </label>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow border border-red-100">
                <h3 class="text-xl font-bold mb-4 text-red-600 flex items-center gap-2">‚ö†Ô∏è Danger Zone</h3>
                <p class="text-sm text-gray-600 mb-4">This action will permanently delete all videos from the database.</p>
                <button onclick="State.deleteAllVideos()" class="w-full bg-white border-2 border-red-500 text-red-500 px-4 py-3 rounded hover:bg-red-50 font-medium transition-colors">
                    üóëÔ∏è Delete All Videos
                </button>
            </div>
        </div>`;
    },

    renderSettingsAdmin() {
        const totalViews = State.videos.reduce((sum, v) => sum + (v.views || 0), 0);
        return `<div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Site Settings</h2>
            <button onclick="UI.showSettingsModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-medium">‚úèÔ∏è Edit Settings</button>
        </div>
        <div class="bg-white rounded-lg p-6 shadow space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="text-sm font-bold text-gray-500 uppercase tracking-wider">Site Title</label>
                    <p class="text-xl font-bold mt-1">${State.siteSettings.title}</p>
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-500 uppercase tracking-wider">Subtitle</label>
                    <p class="text-xl mt-1 text-gray-700">${State.siteSettings.subtitle}</p>
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-500 uppercase tracking-wider">Featured Count</label>
                    <p class="text-xl mt-1">${State.siteSettings.featuredCount}</p>
                </div>
            </div>
            <div class="pt-6 border-t">
                <h3 class="font-bold mb-4 text-xl">üìä Statistics</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded border border-blue-100">
                        <p class="text-sm text-blue-600 font-medium">Total Videos</p>
                        <p class="text-3xl font-bold text-blue-800">${State.videos.length}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded border border-green-100">
                        <p class="text-sm text-green-600 font-medium">Categories</p>
                        <p class="text-3xl font-bold text-green-800">${State.categories.length}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded border border-purple-100">
                        <p class="text-sm text-purple-600 font-medium">Total Views</p>
                        <p class="text-3xl font-bold text-purple-800">${totalViews}</p>
                    </div>
                </div>
            </div>
        </div>`;
    },

    renderVideoCard(v, isAdmin) {
        const cat = State.categories.find(c => c.id === v.category);
        const isUploaded = v.url && v.url.startsWith('data:video/');
        
        // We use ID to look up the video in watchVideo to avoid passing massive Base64 strings in HTML attributes
        return `<div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col h-full">
            <div class="relative pb-[56.25%] bg-gray-200 group">
                ${v.thumbnail ? `<img src="${v.thumbnail}" class="absolute inset-0 w-full h-full object-cover" alt="${v.title}">` : '<div class="absolute inset-0 flex items-center justify-center text-gray-400 text-6xl">üìπ</div>'}
                
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all flex items-center justify-center">
                   ${!isAdmin ? `<button onclick="UI.watchVideo('${v.id}')" class="opacity-0 group-hover:opacity-100 bg-white text-gray-900 rounded-full w-12 h-12 flex items-center justify-center shadow-lg transform scale-75 group-hover:scale-100 transition-all">‚ñ∂</button>` : ''}
                </div>

                ${v.featured ? '<div class="absolute top-2 right-2 bg-yellow-500 text-white px-2 py-1 rounded text-xs font-bold shadow-sm">‚≠ê FEATURED</div>' : ''}
                ${isUploaded ? '<div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-bold shadow-sm flex items-center gap-1"><span>üìÅ</span> Uploaded</div>' : ''}
            </div>
            <div class="p-4 flex flex-col flex-1">
                <div class="mb-auto">
                    <h3 class="font-bold text-lg mb-2 line-clamp-2 leading-tight">${v.title}</h3>
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2 h-10">${v.description || ''}</p>
                    <div class="flex items-center justify-between mb-3">
                        ${cat ? `<span class="inline-block px-2 py-1 rounded text-xs font-semibold text-white" style="background-color:${cat.color}">${cat.name}</span>` : '<span></span>'}
                        <div class="text-xs text-gray-500 flex items-center gap-1">üëÅÔ∏è ${v.views || 0}</div>
                    </div>
                </div>
                
                ${v.tags && v.tags.length > 0 ? `<div class="flex flex-wrap gap-1 mb-3 pt-2 border-t border-gray-100">
                    ${v.tags.slice(0, 3).map(t => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">#${t}</span>`).join('')}
                    ${v.tags.length > 3 ? `<span class="text-xs text-gray-400 px-1">+${v.tags.length - 3}</span>` : ''}
                </div>` : ''}
                
                <div class="flex gap-2 mt-auto pt-2">
                    ${!isAdmin ? `<button onclick="UI.watchVideo('${v.id}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-medium transition-colors">‚ñ∂ Watch Now</button>` : ''}
                    
                    ${isAdmin ? `
                    <button onclick='UI.showVideoModal(${JSON.stringify(v).replace(/'/g, "&apos;")})' class="flex-1 bg-gray-100 text-gray-700 px-3 py-2 rounded hover:bg-gray-200 text-sm font-medium">‚úèÔ∏è Edit</button>
                    <button onclick="State.deleteVideo('${v.id}')" class="px-3 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 border border-red-100 text-sm">üóëÔ∏è</button>` : ''}
                </div>
            </div>
        </div>`;
    },

    showVideoModal(video = null) {
        this.currentTags = video && video.tags ? [...video.tags] : [];
        this.uploadedVideoData = null;
        this.uploadedThumbnailData = null;
        
        const modal = document.createElement('div');
        modal.id = 'videoModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 overflow-y-auto backdrop-blur-sm';
        
        // Stitched logic for the modal content
        modal.innerHTML = `<div class="bg-white rounded-lg p-6 max-w-2xl w-full my-8 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800">${video ? '‚úèÔ∏è Edit' : '‚ûï Add'} Video</h2>
                <button onclick="UI.closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl transition-colors">√ó</button>
            </div>
            <form id="videoForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Title <span class="text-red-500">*</span></label>
                    <input type="text" id="vTitle" value="${video ? video.title : ''}" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Description</label>
                    <textarea id="vDesc" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3">${video ? video.description || '' : ''}</textarea>
                </div>
                
                <div class="border-2 border-dashed border-blue-200 rounded-lg p-4 bg-blue-50">
                    <label class="block text-sm font-bold text-blue-800 mb-3">Video Source</label>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">External URL (YouTube, Vimeo, etc.)</label>
                            <input type="url" id="vUrl" value="${video && !video.url.startsWith('data:video') ? video.url : ''}" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500" placeholder="https://youtube.com/watch?v=...">
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="h-px bg-gray-300 flex-1"></div>
                            <span class="text-xs text-gray-500 font-bold">OR UPLOAD</span>
                            <div class="h-px bg-gray-300 flex-1"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Upload Video File (Max 30MB)</label>
                            <input type="file" id="vFile" accept="video/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                            <p id="videoUploadStatus" class="text-xs text-green-600 mt-1 font-bold hidden">‚úì Video file selected & processed</p>
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg p-4 bg-gray-50">
                    <label class="block text-sm font-medium mb-2 text-gray-700">Thumbnail Image</label>
                    <div class="flex flex-col md:flex-row gap-4 items-start">
                        <div class="flex-1 w-full">
                            <label class="block text-xs text-gray-500 mb-1">Image URL</label>
                            <input type="url" id="vThumb" value="${video && !video.thumbnail?.startsWith('data:') ? video.thumbnail || '' : ''}" class="w-full border rounded px-3 py-2" placeholder="https://...">
                            <div class="text-center text-xs text-gray-400 my-2">- OR -</div>
                            <label class="block text-xs text-gray-500 mb-1">Upload Image (Max 5MB)</label>
                            <input type="file" id="vThumbFile" accept="image/*" class="w-full text-xs">
                        </div>
                        <div class="w-24 h-24 bg-gray-200 rounded flex items-center justify-center overflow-hidden border">
                            <img id="thumbPreview" src="${video && video.thumbnail ? video.thumbnail : ''}" class="w-full h-full object-cover ${video && video.thumbnail ? '' : 'hidden'}">
                            <span class="${video && video.thumbnail ? 'hidden' : ''} text-gray-400 text-xs text-center p-1">No Image</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Category</label>
                        <select id="vCat" class="w-full border rounded px-3 py-2 bg-white">
                            <option value="">None</option>
                            ${State.categories.map(c => `<option value="${c.id}"${video && video.category === c.id ? ' selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex items-center pt-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="vFeatured" ${video && video.featured ? 'checked' : ''} class="w-5 h-5 text-blue-600 rounded">
                            <span class="text-sm font-medium">‚≠ê Featured Video</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Tags</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="tagInput" class="flex-1 border rounded px-3 py-2" placeholder="Type tag and press Enter">
                        <button type="button" onclick="UI.addTagToList()" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-black">Add</button>
                    </div>
                    <div id="tagList" class="flex flex-wrap gap-2 min-h-[30px]"></div>
                </div>

                <div class="flex gap-3 pt-4 border-t">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-bold shadow-lg shadow-blue-200 transition-all">üíæ Save Video</button>
                    <button type="button" onclick="UI.closeModal()" class="flex-1 bg-gray-100 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-200 font-medium transition-all">Cancel</button>
                </div>
            </form>
        </div>`;
        
        document.body.appendChild(modal);
        this.updateTagList();
        
        // Event Listeners for Uploads
        document.getElementById('vFile').onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                // Clear URL input to avoid confusion
                const urlInput = document.getElementById('vUrl');
                urlInput.value = '';
                urlInput.placeholder = "File selected. Clear file to use URL.";
                urlInput.disabled = true;
                
                const result = await FileHandler.handleVideoUpload(file);
                if (result) {
                    this.uploadedVideoData = result;
                    document.getElementById('videoUploadStatus').classList.remove('hidden');
                } else {
                    e.target.value = ''; // Reset on failure
                    urlInput.disabled = false;
                    urlInput.placeholder = "https://youtube.com/watch?v=...";
                }
            }
        };
        
        document.getElementById('vThumbFile').onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('vThumb').value = '';
                const result = await FileHandler.handleImageUpload(file);
                if (result) {
                    this.uploadedThumbnailData = result;
                    const preview = document.getElementById('thumbPreview');
                    preview.src = result;
                    preview.classList.remove('hidden');
                    preview.nextElementSibling.classList.add('hidden');
                }
            }
        };

        // Form Submission
        document.getElementById('videoForm').onsubmit = async (e) => {
            e.preventDefault();
            
            // Determine Video Source
            let videoUrl = document.getElementById('vUrl').value.trim();
            if (this.uploadedVideoData) {
                videoUrl = this.uploadedVideoData;
            }
            
            if (!videoUrl) {
                alert('Please provide a video URL or upload a video file');
                return;
            }
            
            // Determine Thumbnail
            let thumbnail = document.getElementById('vThumb').value.trim();
            if (this.uploadedThumbnailData) {
                thumbnail = this.uploadedThumbnailData;
            }
            
            const data = {
                title: document.getElementById('vTitle').value,
                description: document.getElementById('vDesc').value,
                url: videoUrl,
                thumbnail: thumbnail,
                category: document.getElementById('vCat').value,
                tags: this.currentTags,
                featured: document.getElementById('vFeatured').checked
            };
            
            if (video) {
                State.updateVideo(video.id, data);
            } else {
                State.addVideo(data);
            }
            
            UI.closeModal();
            UI.render();
        };
        
        document.getElementById('tagInput').onkeypress = e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                UI.addTagToList();
            }
        };
    },

    addTagToList() {
        const input = document.getElementById('tagInput');
        const tag = input.value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        if (tag && !this.currentTags.includes(tag)) {
            this.currentTags.push(tag);
            input.value = '';
            this.updateTagList();
        }
    },

    updateTagList() {
        const list = document.getElementById('tagList');
        if (list) {
            list.innerHTML = this.currentTags.map(t => `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                #${t}
                <button type="button" onclick="UI.removeTagFromList('${t}')" class="text-blue-400 hover:text-red-500 font-bold leading-none">√ó</button>
            </span>`).join('');
        }
    },

    removeTagFromList(tag) {
        this.currentTags = this.currentTags.filter(t => t !== tag);
        this.updateTagList();
    },

    showCategoryModal(cat = null) {
        const modal = document.createElement('div');
        modal.id = 'catModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `<div class="bg-white rounded-lg p-6 max-w-md w-full animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">${cat ? '‚úèÔ∏è Edit' : '‚ûï Add'} Category</h2>
                <button onclick="UI.closeModal()" class="text-2xl hover:bg-gray-100 rounded px-2">√ó</button>
            </div>
            <form id="catForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Name *</label>
                    <input type="text" id="cName" value="${cat ? cat.name : ''}" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Color</label>
                    <div class="flex gap-2">
                        <input type="color" id="cColor" value="${cat ? cat.color : '#3b82f6'}" class="w-16 h-10 border rounded cursor-pointer">
                        <input type="text" id="cColorText" value="${cat ? cat.color : '#3b82f6'}" class="flex-1 border rounded px-3 py-2 uppercase" pattern="^#[0-9A-Fa-f]{6}$">
                    </div>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-medium">üíæ Save</button>
                    <button type="button" onclick="UI.closeModal()" class="flex-1 bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 font-medium">Cancel</button>
                </div>
            </form>
        </div>`;
        
        document.body.appendChild(modal);
        
        document.getElementById('cColor').oninput = e => document.getElementById('cColorText').value = e.target.value;
        document.getElementById('cColorText').oninput = e => document.getElementById('cColor').value = e.target.value;
        
        document.getElementById('catForm').onsubmit = e => {
            e.preventDefault();
            const data = {
                name: document.getElementById('cName').value,
                color: document.getElementById('cColor').value
            };
            if (cat) {
                State.updateCategory(cat.id, data);
            } else {
                State.addCategory(data);
            }
            UI.closeModal();
            UI.render();
        };
    },

    showSettingsModal() {
        const modal = document.createElement('div');
        modal.id = 'setModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        modal.innerHTML = `<div class="bg-white rounded-lg p-6 max-w-md w-full animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">‚öôÔ∏è Site Settings</h2>
                <button onclick="UI.closeModal()" class="text-2xl hover:bg-gray-100 rounded px-2">√ó</button>
            </div>
            <form id="setForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Site Title</label>
                    <input type="text" id="sTitle" value="${State.siteSettings.title}" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Subtitle</label>
                    <input type="text" id="sSub" value="${State.siteSettings.subtitle}" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Featured Videos Count</label>
                    <input type="number" id="sFeat" value="${State.siteSettings.featuredCount}" min="1" max="10" class="w-full border rounded px-3 py-2">
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-medium">üíæ Save</button>
                    <button type="button" onclick="UI.closeModal()" class="flex-1 bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 font-medium">Cancel</button>
                </div>
            </form>
        </div>`;
        
        document.body.appendChild(modal);
        
        document.getElementById('setForm').onsubmit = e => {
            e.preventDefault();
            State.siteSettings = {
                title: document.getElementById('sTitle').value,
                subtitle: document.getElementById('sSub').value,
                featuredCount: parseInt(document.getElementById('sFeat').value)
            };
            State.saveSettings();
            UI.closeModal();
            UI.render();
        };
    },

    closeModal() {
        ['videoModal', 'catModal', 'setModal'].forEach(id => {
            const m = document.getElementById(id);
            if (m) m.remove();
        });
    },

    watchVideo(id) {
        // Fetch video data from State to ensure we have the full URL (including large base64 strings)
        // without passing it through HTML attributes which can crash the browser/DOM
        const video = State.videos.find(v => v.id === id);
        if(!video) return;

        State.incrementViews(id);
        
        const isUploaded = video.url.startsWith('data:video');

        if (isUploaded) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black z-50 flex items-center justify-center p-4 animate-fade-in';
            modal.innerHTML = `<div class="relative w-full max-w-5xl bg-black rounded-lg shadow-2xl overflow-hidden">
                <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-white z-50 bg-gray-800 bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-100 transition-all">‚úï</button>
                <video controls autoplay class="w-full h-auto max-h-[80vh] outline-none">
                    <source src="${video.url}" type="video/mp4">
                    <source src="${video.url}" type="video/webm">
                    <source src="${video.url}" type="video/ogg">
                    Your browser doesn't support video playback.
                </video>
                <div class="p-4 bg-gray-900 text-white">
                    <h3 class="font-bold text-lg">${video.title}</h3>
                </div>
            </div>`;
            document.body.appendChild(modal);
        } else {
            // Handle external URLs
            let url = video.url;
            // Simple YouTube embed transform for better UX
            if(url.includes('youtube.com/watch?v=') || url.includes('youtu.be/')) {
                const videoId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `<div class="relative w-full max-w-5xl aspect-video bg-black shadow-2xl">
                    <button onclick="this.closest('.fixed').remove()" class="absolute -top-12 right-0 text-white text-xl hover:text-gray-300">Close ‚úï</button>
                    <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>`;
                document.body.appendChild(modal);
            } else {
                window.open(url, '_blank');
            }
        }
    },

    handleImport(event) {
        const file = event.target.files[0];
        if (file) {
            State.importData(file);
        }
    },

    attachLoginListeners() {
        document.getElementById('loginForm').onsubmit = e => {
            e.preventDefault();
            if (document.getElementById('adminPassword').value === 'ilovegoon') {
                State.isAdmin = true;
                State.currentView = 'admin';
                UI.render();
            } else {
                alert('Incorrect password');
            }
        };
        document.getElementById('backToPublic').onclick = () => {
            State.currentView = 'public';
            UI.render();
        };
    },

    attachPublicListeners() {
        document.getElementById('adminLoginBtn').onclick = () => {
            State.currentView = 'login';
            UI.render();
        };
        document.getElementById('searchInput').oninput = e => {
            State.searchTerm = e.target.value;
            UI.render();
        };
        document.getElementById('categoryFilter').onchange = e => {
            State.selectedCategory = e.target.value;
            UI.render();
        };
        document.getElementById('tagFilter').onchange = e => {
            State.selectedTag = e.target.value;
            UI.render();
        };
        document.getElementById('sortFilter').onchange = e => {
            State.sortBy = e.target.value;
            UI.render();
        };
    },

    attachAdminListeners() {
        document.getElementById('viewPublic').onclick = () => {
            State.currentView = 'public';
            UI.render();
        };
    }
};

async function init() {
    await DataManager.initialize();
    await State.load();
    UI.render();
}

init();
</script>
</body>
</html>
