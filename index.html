<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Video CMS - Pro Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
<style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
    .video-card video { width: 100%; height: 100%; object-fit: cover; border-radius: 1rem; }
    .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
</style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
<div id="app">
    <div class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-bold text-slate-500 uppercase tracking-widest text-xs">Establishing Global Connection...</p>
        </div>
    </div>
</div>

<script>
// --- GLOBAL SYNC CONFIG (FIXED PEERS) ---
// I am using a larger list of peers to ensure "Everyone Sees It"
const gun = Gun({
    peers: [
        'https://gun-manhattan.herokuapp.com/gun',
        'https://peer.wall.org/gun',
        'https://gun-us.herokuapp.com/gun',
        'https://gun-eu.herokuapp.com/gun',
        'https://p2p.dweb.link/gun'
    ],
    localStorage: false // DISABLE localStorage to stop the "QuotaExceeded" error
});

const videoDB = gun.get('netlify_pro_v10_videos');
const catDB = gun.get('netlify_pro_v10_cats');
const userCountDB = gun.get('netlify_pro_v10_presence');

const State = {
    isAdmin: false,
    currentView: 'public',
    videos: [],
    categories: [],
    liveCount: 1,
    myId: Math.random().toString(36).substr(2, 9),

    async init() {
        // Sync Categories
        catDB.map().on((name, id) => {
            if (name) {
                const i = this.categories.findIndex(c => c.id === id);
                if (i > -1) this.categories[i].name = name;
                else this.categories.push({id, name});
            } else {
                this.categories = this.categories.filter(c => c.id !== id);
            }
            UI.render();
        });

        // Sync Videos
        videoDB.map().on((data, id) => {
            if (data) {
                const i = this.videos.findIndex(v => v.id === id);
                const item = {...data, id, tags: data.tags ? data.tags.split(',') : []};
                if (i > -1) this.videos[i] = item;
                else this.videos.push(item);
            } else {
                this.videos = this.videos.filter(v => v.id !== id);
            }
            UI.render();
        });

        // Global Live Count (Presence)
        setInterval(() => userCountDB.get(this.myId).put(Date.now()), 3000);
        userCountDB.map().on((t, id) => {
            if (Date.now() - t > 10000) userCountDB.get(id).put(null);
            this.updateCounter();
        });
    },

    updateCounter() {
        userCountDB.once(data => {
            if(data) {
                const active = Object.values(data).filter(v => v && (Date.now() - v < 10000));
                this.liveCount = active.length || 1;
                const el = document.getElementById('liveCounter');
                if (el) el.innerText = this.liveCount;
            }
        });
    }
};

const UI = {
    render() {
        const app = document.getElementById('app');
        if (State.currentView === 'login') app.innerHTML = this.renderLogin();
        else if (State.currentView === 'admin') app.innerHTML = this.renderAdmin();
        else app.innerHTML = this.renderPublic();
    },

    renderLogin() {
        return `
        <div class="min-h-screen flex items-center justify-center p-6 bg-slate-200">
            <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm">
                <h2 class="text-3xl font-black mb-2 text-center">Admin</h2>
                <p class="text-slate-400 text-center mb-8 text-sm">Enter password to manage site</p>
                <input type="password" id="pass" class="w-full bg-slate-100 border-none p-4 rounded-2xl mb-4" placeholder="Password">
                <button onclick="UI.login()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200">Enter Dashboard</button>
                <button onclick="State.currentView='public';UI.render()" class="w-full mt-4 text-slate-400 text-xs font-bold uppercase tracking-widest">Back</button>
            </div>
        </div>`;
    },

    login() {
        if(document.getElementById('pass').value === 'ilovegoon') {
            State.isAdmin = true; State.currentView = 'admin'; UI.render();
        } else alert('Wrong');
    },

    renderPublic() {
        return `
        <nav class="glass sticky top-0 z-50 px-6 py-4 border-b border-white">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-black text-indigo-600">VIDEO.HUB</h1>
                <div class="flex items-center gap-4">
                    <div class="bg-rose-500 text-white px-3 py-1 rounded-full text-[10px] font-black flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-white rounded-full animate-ping"></span>
                        <span id="liveCounter">${State.liveCount}</span> LIVE
                    </div>
                    <button onclick="State.currentView='login';UI.render()" class="text-slate-400 hover:text-indigo-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    </button>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                ${State.videos.sort((a,b)=>b.time-a.time).map(v => this.renderCard(v)).join('')}
            </div>
        </main>`;
    },

    renderAdmin() {
        return `
        <div class="min-h-screen bg-slate-100 p-6">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-3xl font-black">Dashboard</h2>
                    <button onclick="State.currentView='public';UI.render()" class="bg-white px-6 py-2 rounded-full font-bold shadow-sm">Exit</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-[2rem] shadow-sm">
                        <h3 class="font-bold mb-6 text-indigo-600">Add New Video</h3>
                        <div class="space-y-4">
                            <input id="upTitle" placeholder="Title" class="w-full bg-slate-50 p-4 rounded-xl outline-none">
                            <input id="upTags" placeholder="Tags (comma separated)" class="w-full bg-slate-50 p-4 rounded-xl outline-none">
                            <select id="upCat" class="w-full bg-slate-50 p-4 rounded-xl outline-none">
                                <option value="">Category</option>
                                ${State.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <div class="p-4 border-2 border-dashed rounded-xl border-slate-200">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Video File (Any Size)</p>
                                <input type="file" id="upFile" accept="video/*" class="text-xs">
                            </div>
                            <button id="upBtn" onclick="UI.upload()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold">Publish to Global Feed</button>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div class="bg-white p-8 rounded-[2rem] shadow-sm">
                            <h3 class="font-bold mb-4">Categories</h3>
                            <div class="flex gap-2 mb-4">
                                <input id="newCat" class="flex-1 bg-slate-50 p-2 rounded-lg outline-none" placeholder="New Cat...">
                                <button onclick="UI.addCat()" class="bg-indigo-600 text-white px-4 rounded-lg">+</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${State.categories.map(c=>`<span class="bg-slate-100 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2">${c.name} <button onclick="UI.delCat('${c.id}')" class="text-rose-500">✕</button></span>`).join('')}
                            </div>
                        </div>

                        <div class="bg-white p-8 rounded-[2rem] shadow-sm">
                            <h3 class="font-bold mb-4">Manage Feed</h3>
                            <div class="divide-y max-h-60 overflow-y-auto">
                                ${State.videos.map(v=>`
                                    <div class="py-3 flex justify-between items-center">
                                        <span class="text-sm font-medium truncate w-40">${v.title}</span>
                                        <button onclick="UI.delVid('${v.id}')" class="text-rose-500 text-xs font-bold uppercase">Delete</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    },

    renderCard(v) {
        return `
        <div onclick="UI.play('${v.id}')" class="group cursor-pointer">
            <div class="aspect-video bg-slate-900 rounded-[2rem] overflow-hidden relative shadow-xl transform transition-transform group-hover:scale-[1.03]">
                <video src="${v.url}" muted></video>
                <div class="absolute inset-0 bg-indigo-900/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-2xl">
                        <svg class="w-8 h-8 text-indigo-600 ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3.5l11 6.5-11 6.5V3.5z"/></svg>
                    </div>
                </div>
            </div>
            <div class="mt-4 px-2">
                <h3 class="font-bold text-lg leading-tight truncate">${v.title}</h3>
                <div class="flex gap-2 mt-1">
                    ${v.tags.map(t=>`<span class="text-[10px] font-bold text-slate-400">#${t.trim()}</span>`).join('')}
                </div>
            </div>
        </div>`;
    },

    async upload() {
        const title = document.getElementById('upTitle').value;
        const file = document.getElementById('upFile').files[0];
        const btn = document.getElementById('upBtn');
        if(!title || !file) return alert("Missing Info");

        btn.disabled = true;
        btn.innerText = "Processing Large File...";

        const reader = new FileReader();
        reader.onload = () => {
            const id = Math.random().toString(36).substr(2, 9);
            videoDB.get(id).put({
                title, 
                url: reader.result, 
                category: document.getElementById('upCat').value,
                tags: document.getElementById('upTags').value,
                time: Date.now()
            });
            btn.disabled = false;
            btn.innerText = "Published!";
            setTimeout(()=>UI.render(), 1000);
        };
        reader.readAsDataURL(file);
    },

    addCat() {
        const n = document.getElementById('newCat').value;
        if(n) catDB.get(Math.random().toString(36).substr(2,9)).put(n);
        document.getElementById('newCat').value = '';
    },

    delCat(id) { if(confirm("Del?")) catDB.get(id).put(null); },
    delVid(id) { if(confirm("Del?")) videoDB.get(id).put(null); },

    play(id) {
        const v = State.videos.find(x=>x.id===id);
        const m = document.createElement('div');
        m.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4';
        m.onclick = (e) => { if(e.target === m) m.remove(); };
        m.innerHTML = `<div class="w-full max-w-5xl relative">
            <button onclick="this.closest('.fixed').remove()" class="absolute -top-12 right-0 text-white font-bold">CLOSE ✕</button>
            <video src="${v.url}" controls autoplay class="w-full rounded-3xl shadow-2xl"></video>
            <div class="mt-6 text-white"><h2 class="text-3xl font-black">${v.title}</h2></div>
        </div>`;
        document.body.appendChild(m);
    }
};

State.init();
</script>
</body>
</html>
