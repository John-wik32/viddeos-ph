<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Video Feed</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
<style>
    .video-card:hover { transform: translateY(-4px); }
    .status-online { background: #10b981; box-shadow: 0 0 10px #10b981; }
    .status-offline { background: #ef4444; }
    .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
</style>
</head>
<body class="bg-gray-50 text-slate-900">

<div id="app">
    <div class="min-h-screen flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-slate-400 animate-pulse">BOOTING GLOBAL DATABASE...</p>
    </div>
</div>

<script>
// --- DATABASE CONFIG ---
// We use a mix of newer, more stable relay peers
const gun = Gun({
    peers: [
        'https://gun-manhattan.herokuapp.com/gun',
        'https://peer.wall.org/gun',
        'https://gun-us.herokuapp.com/gun',
        'https://gun-eu.herokuapp.com/gun',
        'https://gun-ams1.marda.no/gun'
    ],
    localStorage: false // Disable localStorage to use IndexedDB (unlimited space)
});

const videoDB = gun.get('prod_v8_videos');
const catDB = gun.get('prod_v8_cats');

const State = {
    isAdmin: false,
    currentView: 'public',
    videos: [],
    categories: [],
    isConnected: false,

    init() {
        // Monitor Connection Status
        gun.on('hi', () => { State.isConnected = true; UI.render(); });
        gun.on('bye', () => { State.isConnected = false; UI.render(); });

        // Sync Categories
        catDB.map().on((name, id) => {
            if (name) {
                const i = this.categories.findIndex(c => c.id === id);
                if (i > -1) this.categories[i].name = name;
                else this.categories.push({id, name});
            } else {
                this.categories = this.categories.filter(c => c.id !== id);
            }
            UI.render();
        });

        // Sync Videos
        videoDB.map().on((data, id) => {
            if (data) {
                const i = this.videos.findIndex(v => v.id === id);
                const item = {...data, id, tags: data.tags ? data.tags.split(',') : []};
                if (i > -1) this.videos[i] = item;
                else this.videos.push(item);
            } else {
                this.videos = this.videos.filter(v => v.id !== id);
            }
            UI.render();
        });

        // If no connection after 3 seconds, show the UI anyway
        setTimeout(() => UI.render(), 3000);
    }
};

const UI = {
    render() {
        const app = document.getElementById('app');
        if (State.currentView === 'login') app.innerHTML = this.renderLogin();
        else if (State.currentView === 'admin') app.innerHTML = this.renderAdmin();
        else app.innerHTML = this.renderPublic();
    },

    renderPublic() {
        return `
        <nav class="glass sticky top-0 z-50 border-b border-gray-200 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex flex-col">
                    <h1 class="text-xl font-black tracking-tighter text-indigo-600">MEDIA.PRO</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-2 h-2 rounded-full ${State.isConnected ? 'status-online' : 'status-offline'}"></div>
                        <span class="text-[9px] font-black uppercase tracking-widest text-gray-400">
                            ${State.isConnected ? 'Syncing Globally' : 'Network Error: Connecting...'}
                        </span>
                    </div>
                </div>
                <button onclick="State.currentView='login';UI.render()" class="p-2 bg-gray-100 rounded-full hover:bg-indigo-50 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6">
            ${State.videos.length === 0 ? `
                <div class="py-20 text-center">
                    <div class="text-4xl mb-4">ðŸ“º</div>
                    <p class="text-gray-400 font-medium">No videos found. Check connection or add one in Admin.</p>
                </div>
            ` : ''}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                ${State.videos.sort((a,b)=>b.time-a.time).map(v => this.renderCard(v)).join('')}
            </div>
        </main>`;
    },

    renderAdmin() {
        return `
        <div class="min-h-screen bg-white p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-3xl font-black">Control Panel</h2>
                    <button onclick="State.currentView='public';UI.render()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg">View Live Feed</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                            <h3 class="font-bold mb-4 uppercase text-xs tracking-widest text-indigo-500">Add New Video</h3>
                            <input id="vTitle" placeholder="Title" class="w-full mb-3 p-3 rounded-xl border-none ring-1 ring-gray-200 outline-none focus:ring-2 focus:ring-indigo-500">
                            <input id="vUrl" placeholder="Direct MP4 Link" class="w-full mb-3 p-3 rounded-xl border-none ring-1 ring-gray-200 outline-none focus:ring-2 focus:ring-indigo-500">
                            <select id="vCat" class="w-full mb-4 p-3 rounded-xl border-none ring-1 ring-gray-200">
                                <option value="">Select Category</option>
                                ${State.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <button onclick="UI.publish()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold">Broadcast Globally</button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                            <h3 class="font-bold mb-4 uppercase text-xs tracking-widest text-indigo-500">Manage Categories</h3>
                            <div class="flex gap-2 mb-4">
                                <input id="nCat" class="flex-1 p-2 rounded-lg ring-1 ring-gray-200 outline-none" placeholder="Name...">
                                <button onclick="UI.addCat()" class="bg-indigo-600 text-white px-4 rounded-lg font-bold">+</button>
                            </div>
                            <div class="space-y-2">
                                ${State.categories.map(c=>`
                                    <div class="flex justify-between bg-white p-2 rounded-lg border text-sm font-medium">
                                        ${c.name} <button onclick="UI.delCat('${c.id}')" class="text-red-500">âœ•</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    },

    renderCard(v) {
        return `
        <div onclick="UI.play('${v.id}')" class="video-card group cursor-pointer transition-all duration-300">
            <div class="aspect-video bg-slate-900 rounded-[2.5rem] overflow-hidden relative shadow-lg">
                <video src="${v.url}" muted class="w-full h-full object-cover"></video>
                <div class="absolute inset-0 bg-indigo-900/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-xl">
                        <svg class="w-6 h-6 text-indigo-600 ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3.5l11 6.5-11 6.5V3.5z"/></svg>
                    </div>
                </div>
            </div>
            <div class="mt-4 px-2">
                <h3 class="font-bold text-lg leading-tight truncate">${v.title}</h3>
                <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mt-1">
                    ${State.categories.find(c=>c.id===v.category)?.name || 'Misc'}
                </p>
            </div>
        </div>`;
    },

    publish() {
        const title = document.getElementById('vTitle').value;
        const url = document.getElementById('vUrl').value;
        if(!title || !url) return alert("Missing fields");

        videoDB.get(Math.random().toString(36).substr(2,9)).put({
            title, url, 
            category: document.getElementById('vCat').value,
            time: Date.now()
        });
        alert("Published!");
        UI.render();
    },

    addCat() {
        const n = document.getElementById('nCat').value;
        if(n) catDB.get(Math.random().toString(36).substr(2,9)).put(n);
        document.getElementById('nCat').value = '';
    },

    delCat(id) { if(confirm("Delete?")) catDB.get(id).put(null); },

    play(id) {
        const v = State.videos.find(x=>x.id===id);
        const m = document.createElement('div');
        m.className = 'fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4';
        m.onclick = (e) => { if(e.target === m) m.remove(); };
        m.innerHTML = `<div class="w-full max-w-5xl">
            <video src="${v.url}" controls autoplay class="w-full rounded-3xl shadow-2xl"></video>
            <h2 class="mt-6 text-white text-2xl font-bold">${v.title}</h2>
        </div>`;
        document.body.appendChild(m);
    },

    renderLogin() {
        return `
        <div class="min-h-screen flex items-center justify-center bg-slate-100 p-6">
            <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
                <h2 class="text-3xl font-black mb-6">Admin Login</h2>
                <input type="password" id="pw" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 border-none ring-1 ring-gray-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                <button onclick="UI.login()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">Enter Dashboard</button>
                <button onclick="State.currentView='public';UI.render()" class="mt-4 text-gray-400 text-sm">Cancel</button>
            </div>
        </div>`;
    },

    login() {
        if(document.getElementById('pw').value === 'ilovegoon') {
            State.isAdmin = true; State.currentView = 'admin'; UI.render();
        } else alert('Access Denied');
    }
};

State.init();
</script>
</body>
</html>
