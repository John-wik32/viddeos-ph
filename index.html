<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Library CMS</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    @keyframes pulse-live {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .animate-pulse-live {
        animation: pulse-live 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .video-container video {
        width: 100%;
        max-height: 80vh;
        background: black;
    }
</style>
</head>
<body class="bg-gray-50 text-gray-800">
<div id="app"></div>

<script>
/**
 * TO MAKE THIS WORK FOR EVERYONE:
 * Paste your Firebase config here. 
 * Get this from: Firebase Console -> Project Settings -> General -> Your Apps
 */
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- Data & State Management ---

const State = {
    isAdmin: false,
    currentView: 'public',
    adminView: 'videos',
    videos: [],
    categories: [],
    tags: [],
    siteSettings: {},
    searchTerm: '',
    selectedCategory: 'all',
    selectedTag: 'all',
    sortBy: 'newest',
    liveUsers: 1,
    
    async init() {
        // 1. Listen for Live User Count (Presence)
        const userRef = db.ref('presence/' + Date.now());
        userRef.onDisconnect().remove();
        userRef.set(true);

        db.ref('presence').on('value', (snapshot) => {
            this.liveUsers = snapshot.numChildren();
            const counterEl = document.getElementById('liveCounter');
            if (counterEl) counterEl.innerText = this.liveUsers;
        });

        // 2. Listen for Site Settings
        db.ref('siteSettings').on('value', (snapshot) => {
            this.siteSettings = snapshot.val() || {title: 'Video Library', subtitle: 'Explore our collection', featuredCount: 3};
            UI.render();
        });

        // 3. Listen for Categories
        db.ref('categories').on('value', (snapshot) => {
            const data = snapshot.val();
            this.categories = data ? Object.values(data) : [];
            UI.render();
        });

        // 4. Listen for Videos
        db.ref('videos').on('value', (snapshot) => {
            const data = snapshot.val();
            this.videos = data ? Object.values(data) : [];
            this.updateAllTags();
            UI.render();
        });
    },

    updateAllTags() {
        const allTags = new Set();
        this.videos.forEach(v => {
            if (v.tags && Array.isArray(v.tags)) {
                v.tags.forEach(t => allTags.add(t));
            }
        });
        this.tags = [...allTags].sort();
    },
    
    async saveSettings() { await db.ref('siteSettings').set(this.siteSettings); },
    
    async addVideo(video) {
        const id = Date.now().toString();
        const newVideo = {...video, id, views: 0, createdAt: new Date().toISOString()};
        await db.ref('videos/' + id).set(newVideo);
    },
    
    async updateVideo(id, updates) {
        await db.ref('videos/' + id).update(updates);
    },
    
    async deleteVideo(id) {
        if (confirm('Delete this video?')) {
            await db.ref('videos/' + id).remove();
        }
    },
    
    async incrementViews(id) {
        const video = this.videos.find(v => v.id === id);
        if (video) {
            await db.ref('videos/' + id).update({ views: (video.views || 0) + 1 });
        }
    },
    
    async addCategory(category) {
        const id = Date.now().toString();
        await db.ref('categories/' + id).set({...category, id});
    },
    
    async deleteCategory(id) {
        if (confirm('Delete this category?')) {
            await db.ref('categories/' + id).remove();
        }
    },
    
    getFilteredVideos() {
        let filtered = [...this.videos];
        if (this.searchTerm) {
            const term = this.searchTerm.toLowerCase();
            filtered = filtered.filter(v => v.title.toLowerCase().includes(term) || (v.description && v.description.toLowerCase().includes(term)));
        }
        if (this.selectedCategory !== 'all') {
            filtered = filtered.filter(v => v.category === this.selectedCategory);
        }
        if (this.selectedTag !== 'all') {
            filtered = filtered.filter(v => v.tags && v.tags.includes(this.selectedTag));
        }
        filtered.sort((a, b) => {
            switch (this.sortBy) {
                case 'newest': return new Date(b.createdAt) - new Date(a.createdAt);
                case 'oldest': return new Date(a.createdAt) - new Date(b.createdAt);
                case 'mostViewed': return (b.views || 0) - (a.views || 0);
                default: return 0;
            }
        });
        return filtered;
    },
    
    getFeaturedVideos() {
        return this.videos.filter(v => v.featured).slice(0, this.siteSettings.featuredCount);
    }
};

const FileHandler = {
    async fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },
    
    async handleVideoUpload(file) {
        if (!file.type.startsWith('video/')) {
            alert('Please select a video file');
            return null;
        }
        // Note: Realtime Database has a 10MB limit per record. 
        // For larger files, you should use Firebase Storage.
        if (file.size > 10 * 1024 * 1024) {
            alert('File too large (Max 10MB for direct DB upload). Use a YouTube link or set up Firebase Storage.');
            return null;
        }
        try {
            return await this.fileToBase64(file);
        } catch (error) {
            return null;
        }
    }
};

// --- UI Logic ---

const UI = {
    currentTags: [],
    uploadedVideoData: null,
    uploadedThumbnailData: null,
    
    render() {
        const app = document.getElementById('app');
        if (State.currentView === 'login') {
            app.innerHTML = this.renderLogin();
            this.attachLoginListeners();
        } else if (State.currentView === 'admin') {
            app.innerHTML = this.renderAdmin();
            this.attachAdminListeners();
        } else {
            app.innerHTML = this.renderPublic();
            this.attachPublicListeners();
        }
    },

    renderLogin() {
        return `<div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
                <h1 class="text-2xl font-bold mb-6 text-center">Admin Login</h1>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="adminPassword" class="w-full border rounded px-3 py-2" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-medium">Login</button>
                    <button type="button" id="backToPublic" class="w-full bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 font-medium">Back to Site</button>
                </form>
            </div>
        </div>`;
    },

    renderPublic() {
        const featured = State.getFeaturedVideos();
        const filtered = State.getFilteredVideos();
        return `<div class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">${State.siteSettings.title}</h1>
                        <p class="text-gray-600 text-sm md:text-base">${State.siteSettings.subtitle}</p>
                    </div>
                    
                    <div class="flex items-center gap-2 bg-red-50 text-red-600 px-3 py-1 rounded-full border border-red-100">
                        <span class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                        </span>
                        <span class="text-sm font-bold"><span id="liveCounter">${State.liveUsers}</span> Live Viewers</span>
                    </div>

                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="text" id="searchInput" class="w-full md:w-64 border rounded-lg px-4 py-2" placeholder="Search videos..." value="${State.searchTerm}">
                        <button id="adminLoginBtn" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-black text-sm font-medium">Admin</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-3">
                <select id="categoryFilter" class="border rounded px-3 py-2 text-sm bg-gray-50">
                    <option value="all">All Categories</option>
                    ${State.categories.map(c => `<option value="${c.id}"${State.selectedCategory === c.id ? ' selected' : ''}>${c.name}</option>`).join('')}
                </select>
                <select id="tagFilter" class="border rounded px-3 py-2 text-sm bg-gray-50">
                    <option value="all">All Tags</option>
                    ${State.tags.map(t => `<option value="${t}"${State.selectedTag === t ? ' selected' : ''}>#${t}</option>`).join('')}
                </select>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 py-8">
            ${featured.length > 0 && !State.searchTerm ? `
            <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">‚≠ê Featured</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${featured.map(v => this.renderVideoCard(v, false)).join('')}
                </div>
            </div>` : ''}
            
            <h2 class="text-2xl font-bold mb-6">üìπ Videos (${filtered.length})</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${filtered.map(v => this.renderVideoCard(v, false)).join('')}
            </div>
        </div>`;
    },

    renderAdmin() {
        return `<div class="bg-gray-900 text-white sticky top-0 z-20 shadow-md">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl font-bold">Admin Dashboard</h1>
                <button id="viewPublic" class="bg-blue-600 px-4 py-2 rounded text-sm">View Site</button>
            </div>
        </div>
        <div class="bg-white border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-4 flex gap-4">
                <button class="py-3 ${State.adminView === 'videos' ? 'border-b-2 border-blue-500' : ''}" onclick="State.adminView='videos';UI.render()">Videos</button>
                <button class="py-3 ${State.adminView === 'categories' ? 'border-b-2 border-blue-500' : ''}" onclick="State.adminView='categories';UI.render()">Categories</button>
                <button class="py-3 ${State.adminView === 'settings' ? 'border-b-2 border-blue-500' : ''}" onclick="State.adminView='settings';UI.render()">Settings</button>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 py-8">
            ${State.adminView === 'videos' ? this.renderVideosAdmin() : 
              State.adminView === 'categories' ? this.renderCategoriesAdmin() : 
              this.renderSettingsAdmin()}
        </div>`;
    },

    renderVideosAdmin() {
        return `<div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Manage Videos</h2>
            <button onclick="UI.showVideoModal()" class="bg-blue-500 text-white px-4 py-2 rounded">Add Video</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            ${State.videos.map(v => this.renderVideoCard(v, true)).join('')}
        </div>`;
    },

    renderCategoriesAdmin() {
        return `<div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Categories</h2>
            <button onclick="UI.showCategoryModal()" class="bg-blue-500 text-white px-4 py-2 rounded">Add Category</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${State.categories.map(c => `<div class="bg-white p-4 rounded shadow flex justify-between">
                <span>${c.name}</span>
                <button onclick="State.deleteCategory('${c.id}')" class="text-red-500">üóëÔ∏è</button>
            </div>`).join('')}
        </div>`;
    },

    renderSettingsAdmin() {
        return `<div class="max-w-md bg-white p-6 rounded shadow">
            <h2 class="text-xl font-bold mb-4">Site Settings</h2>
            <div class="space-y-4">
                <input type="text" id="sTitle" value="${State.siteSettings.title}" class="w-full border p-2 rounded">
                <input type="text" id="sSub" value="${State.siteSettings.subtitle}" class="w-full border p-2 rounded">
                <button onclick="UI.saveSettings()" class="w-full bg-blue-500 text-white py-2 rounded">Save Settings</button>
            </div>
        </div>`;
    },

    saveSettings() {
        State.siteSettings.title = document.getElementById('sTitle').value;
        State.siteSettings.subtitle = document.getElementById('sSub').value;
        State.saveSettings();
        alert('Settings Saved!');
    },

    renderVideoCard(v, isAdmin) {
        const cat = State.categories.find(c => c.id === v.category);
        const isUploaded = v.url && v.url.startsWith('data:video');
        
        return `<div class="bg-white rounded-lg shadow overflow-hidden flex flex-col h-full">
            <div class="relative pb-[56.25%] bg-gray-200">
                ${v.thumbnail ? `<img src="${v.thumbnail}" class="absolute inset-0 w-full h-full object-cover">` : '<div class="absolute inset-0 flex items-center justify-center text-4xl">üìπ</div>'}
                ${isUploaded ? '<div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-xs">UPLOADED</div>' : ''}
            </div>
            <div class="p-4 flex-1 flex flex-col">
                <h3 class="font-bold line-clamp-2 mb-2">${v.title}</h3>
                <div class="flex justify-between text-xs text-gray-500 mb-4">
                    <span>${cat ? cat.name : 'Uncategorized'}</span>
                    <span>üëÅÔ∏è ${v.views || 0}</span>
                </div>
                <div class="mt-auto flex gap-2">
                    <button onclick="UI.watchVideo('${v.id}')" class="flex-1 bg-blue-600 text-white py-2 rounded text-sm">Watch</button>
                    ${isAdmin ? `<button onclick="State.deleteVideo('${v.id}')" class="bg-red-50 px-2 rounded text-red-500">üóëÔ∏è</button>` : ''}
                </div>
            </div>
        </div>`;
    },

    showVideoModal(video = null) {
        this.currentTags = [];
        this.uploadedVideoData = null;
        
        const modal = document.createElement('div');
        modal.id = 'videoModal';
        modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 overflow-y-auto';
        modal.innerHTML = `<div class="bg-white rounded-lg p-6 max-w-lg w-full">
            <h2 class="text-xl font-bold mb-4">Add Video</h2>
            <form id="videoForm" class="space-y-4">
                <input type="text" id="vTitle" placeholder="Title" class="w-full border p-2 rounded" required>
                <textarea id="vDesc" placeholder="Description" class="w-full border p-2 rounded"></textarea>
                
                <div class="p-3 bg-gray-50 rounded border">
                    <label class="block text-xs font-bold mb-1">Source</label>
                    <input type="url" id="vUrl" placeholder="YouTube URL" class="w-full border p-2 rounded mb-2">
                    <div class="text-center text-xs text-gray-400 mb-2">- OR -</div>
                    <input type="file" id="vFile" accept="video/*" class="w-full text-xs">
                    <p id="vLoading" class="hidden text-orange-500 text-xs mt-1 animate-pulse">Processing video...</p>
                </div>

                <div class="flex gap-4">
                    <select id="vCat" class="flex-1 border p-2 rounded">
                        <option value="">Category</option>
                        ${State.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="vFeatured"> Featured
                    </label>
                </div>

                <div class="flex gap-2">
                    <button type="submit" id="saveBtn" class="flex-1 bg-blue-600 text-white py-2 rounded">Save</button>
                    <button type="button" onclick="UI.closeModal()" class="flex-1 bg-gray-200 py-2 rounded">Cancel</button>
                </div>
            </form>
        </div>`;
        document.body.appendChild(modal);

        document.getElementById('vFile').onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('vLoading').classList.remove('hidden');
                this.uploadedVideoData = await FileHandler.handleVideoUpload(file);
                document.getElementById('vLoading').innerText = this.uploadedVideoData ? "‚úÖ Video Ready" : "‚ùå Too Large (Max 10MB)";
            }
        };

        document.getElementById('videoForm').onsubmit = async (e) => {
            e.preventDefault();
            const url = this.uploadedVideoData || document.getElementById('vUrl').value;
            if (!url) return alert("Add a URL or File");

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerText = "Uploading to Cloud...";

            await State.addVideo({
                title: document.getElementById('vTitle').value,
                description: document.getElementById('vDesc').value,
                url: url,
                category: document.getElementById('vCat').value,
                featured: document.getElementById('vFeatured').checked,
                thumbnail: "" // You can add thumbnail logic similarly
            });
            UI.closeModal();
        };
    },

    showCategoryModal() {
        const name = prompt("Category Name:");
        if (name) State.addCategory({name});
    },

    closeModal() {
        const m = document.getElementById('videoModal');
        if (m) m.remove();
    },

    watchVideo(id) {
        const video = State.videos.find(v => v.id === id);
        if(!video) return;

        State.incrementViews(id);
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black z-50 flex items-center justify-center p-4';
        
        const isDirect = video.url.startsWith('data:video') || video.url.match(/\.(mp4|webm|mov)$/);
        
        if (isDirect) {
            modal.innerHTML = `<div class="relative w-full max-w-4xl bg-black rounded shadow-2xl">
                <button onclick="this.closest('.fixed').remove()" class="absolute -top-10 right-0 text-white">Close ‚úï</button>
                <video controls autoplay class="w-full rounded">
                    <source src="${video.url}">
                </video>
            </div>`;
        } else {
            // YouTube Handler
            let embedUrl = video.url;
            if (video.url.includes('youtube.com') || video.url.includes('youtu.be')) {
                const vidId = video.url.split('v=')[1]?.split('&')[0] || video.url.split('/').pop();
                embedUrl = `https://www.youtube.com/embed/${vidId}?autoplay=1`;
            }
            modal.innerHTML = `<div class="relative w-full max-w-4xl aspect-video bg-black rounded">
                <button onclick="this.closest('.fixed').remove()" class="absolute -top-10 right-0 text-white">Close ‚úï</button>
                <iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
            </div>`;
        }
        document.body.appendChild(modal);
    },

    attachLoginListeners() {
        document.getElementById('loginForm').onsubmit = e => {
            e.preventDefault();
            if (document.getElementById('adminPassword').value === 'ilovegoon') {
                State.isAdmin = true;
                State.currentView = 'admin';
                UI.render();
            } else {
                alert('Wrong password');
            }
        };
        document.getElementById('backToPublic').onclick = () => { State.currentView = 'public'; UI.render(); };
    },

    attachPublicListeners() {
        document.getElementById('adminLoginBtn').onclick = () => { State.currentView = 'login'; UI.render(); };
        document.getElementById('searchInput').oninput = e => { State.searchTerm = e.target.value; UI.render(); };
        document.getElementById('categoryFilter').onchange = e => { State.selectedCategory = e.target.value; UI.render(); };
    },

    attachAdminListeners() {
        document.getElementById('viewPublic').onclick = () => { State.currentView = 'public'; UI.render(); };
    }
};

// Start the app
State.init();
</script>
</body>
</html>
