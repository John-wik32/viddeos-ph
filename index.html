<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Site</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
</head>

<body class="bg-slate-100">
<div id="app"></div>

<script>
/* ---------- DATABASE ---------- */
const gun = Gun({
  peers: ['https://gun-manhattan.herokuapp.com/gun']
});
const videoDB = gun.get('netlify_video_links');

/* ---------- STATE ---------- */
const State = {
  view: 'public',
  videos: [],

  init() {
    videoDB.map().on((data, id) => {
      if (!data) {
        this.videos = this.videos.filter(v => v.id !== id);
      } else {
        const v = { ...data, id };
        const i = this.videos.findIndex(x => x.id === id);
        i > -1 ? this.videos[i] = v : this.videos.push(v);
      }
      UI.render();
    });
  }
};

/* ---------- UI ---------- */
const UI = {
  render() {
    document.getElementById('app').innerHTML =
      State.view === 'admin' ? this.admin() : this.public();
  },

  public() {
    return `
    <nav class="bg-white p-4 flex justify-between shadow">
      <h1 class="font-black text-indigo-600">VIDEO HUB</h1>
      <button onclick="State.view='admin';UI.render()">Admin</button>
    </nav>

    <main class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
      ${State.videos.length === 0 ? `
        <p class="text-center col-span-full text-slate-500">
          No videos yet
        </p>` :
        State.videos.map(v => `
          <div class="bg-white p-4 rounded shadow">
            <iframe
              class="w-full aspect-video rounded"
              src="${v.url}"
              allowfullscreen>
            </iframe>
            <h3 class="font-bold mt-2">${v.title}</h3>
          </div>
        `).join('')
      }
    </main>`;
  },

  admin() {
    return `
    <div class="p-6 max-w-xl mx-auto">
      <button onclick="State.view='public';UI.render()">← Back</button>

      <div class="bg-white p-6 mt-4 rounded shadow">
        <h2 class="font-bold mb-4">Add Video</h2>

        <input id="title" placeholder="Title"
          class="w-full p-2 mb-2 bg-slate-100 rounded">

        <input id="url" placeholder="YouTube Embed URL"
          class="w-full p-2 mb-4 bg-slate-100 rounded">

        <button onclick="UI.addVideo()"
          class="bg-indigo-600 text-white px-4 py-2 rounded">
          Add Video
        </button>
      </div>
    </div>`;
  },

  addVideo() {
    const title = document.getElementById('title').value;
    let url = document.getElementById('url').value;

    if (!title || !url) return alert("Missing info");

    // Convert normal YouTube link → embed
    if (url.includes("watch?v=")) {
      url = url.replace("watch?v=", "embed/");
    }

    videoDB.get(Math.random().toString(36).slice(2)).put({
      title,
      url,
      time: Date.now()
    });
  }
};

State.init();
</script>
</body>
</html>
