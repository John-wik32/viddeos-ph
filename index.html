<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Library CMS - Live Global Sync</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .video-card video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .modal-overlay {
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(4px);
    }
</style>
</head>
<body class="bg-gray-50 text-gray-800">
<div id="app"></div>

<script>
// --- Initialize Global Database (Gun.js) ---
// This connects all users together automatically
const gun = Gun([
    'https://gun-manhattan.herokuapp.com/gun',
    'https://peer.wall.org/gun'
]);
const videoDB = gun.get('netlify_cms_videos_v2');
const settingsDB = gun.get('netlify_cms_settings_v2');
const presenceDB = gun.get('netlify_cms_presence_v2');

const State = {
    isAdmin: false,
    currentView: 'public',
    adminView: 'videos',
    videos: [],
    siteSettings: { title: 'Video Library', subtitle: 'Live Global Collection' },
    liveUsers: 1,
    mySessionId: Math.random().toString(36).substr(2, 9),

    async init() {
        // 1. Sync Site Settings
        settingsDB.on(data => {
            if(data) {
                this.siteSettings.title = data.title || this.siteSettings.title;
                this.siteSettings.subtitle = data.subtitle || this.siteSettings.subtitle;
                UI.render();
            }
        });

        // 2. Sync Videos (Global)
        videoDB.map().on((data, id) => {
            if (data) {
                const index = this.videos.findIndex(v => v.id === id);
                if (index > -1) {
                    this.videos[index] = { ...data, id };
                } else {
                    this.videos.push({ ...data, id });
                }
                UI.render();
            } else {
                // Handle deletion
                this.videos = this.videos.filter(v => v.id !== id);
                UI.render();
            }
        });

        // 3. Presence / Live Count Logic
        setInterval(() => {
            presenceDB.get(this.mySessionId).put(Date.now());
        }, 3000);

        presenceDB.map().on((timestamp, id) => {
            const now = Date.now();
            // If we haven't heard from this user in 10 seconds, ignore them
            if (now - timestamp > 10000) {
                presenceDB.get(id).put(null);
            }
            this.updateLiveCount();
        });

        UI.render();
    },

    updateLiveCount() {
        let count = 0;
        presenceDB.once(data => {
            if(data) {
                // Count non-null entries
                count = Object.values(data).filter(v => v && typeof v === 'number').length;
                this.liveUsers = count || 1;
                const counterEl = document.getElementById('liveCounter');
                if (counterEl) counterEl.innerText = this.liveUsers;
            }
        });
    }
};

const UI = {
    render() {
        const app = document.getElementById('app');
        if (State.currentView === 'login') {
            app.innerHTML = this.renderLogin();
        } else if (State.currentView === 'admin') {
            app.innerHTML = this.renderAdmin();
        } else {
            app.innerHTML = this.renderPublic();
        }
    },

    renderLogin() {
        return `
        <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
                <h2 class="text-2xl font-bold mb-6 text-center">Admin Access</h2>
                <input type="password" id="adminPass" class="w-full border p-3 rounded mb-4" placeholder="Password">
                <button onclick="UI.handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Login</button>
                <button onclick="State.currentView='public';UI.render()" class="w-full mt-2 text-gray-500 text-sm">Cancel</button>
            </div>
        </div>`;
    },

    handleLogin() {
        const pass = document.getElementById('adminPass').value;
        if(pass === 'ilovegoon') {
            State.isAdmin = true;
            State.currentView = 'admin';
            UI.render();
        } else {
            alert('Wrong Password');
        }
    },

    renderPublic() {
        return `
        <nav class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black text-blue-600">${State.siteSettings.title}</h1>
                    <p class="text-gray-500 text-xs uppercase tracking-widest">${State.siteSettings.subtitle}</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-red-50 px-3 py-1.5 rounded-full border border-red-100">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        <span class="text-red-600 text-sm font-bold"><span id="liveCounter">${State.liveUsers}</span> ONLINE</span>
                    </div>
                    <button onclick="State.currentView='login';UI.render()" class="text-gray-400 hover:text-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                ${State.videos.length === 0 ? '<p class="col-span-full text-center py-20 text-gray-400">No videos uploaded yet.</p>' : ''}
                ${State.videos.map(v => this.renderVideoCard(v)).join('')}
            </div>
        </main>`;
    },

    renderAdmin() {
        return `
        <div class="min-h-screen bg-gray-50">
            <header class="bg-gray-900 text-white p-4 flex justify-between items-center">
                <span class="font-bold">Admin Dashboard</span>
                <button onclick="State.currentView='public';UI.render()" class="bg-white/10 px-4 py-1 rounded text-sm">Exit</button>
            </header>
            <div class="max-w-4xl mx-auto p-6">
                <div class="bg-white rounded-xl shadow p-6 mb-8">
                    <h3 class="text-lg font-bold mb-4">Upload New Media</h3>
                    <div class="grid gap-4">
                        <input type="text" id="newTitle" placeholder="Video Title" class="border p-3 rounded">
                        <input type="file" id="newFile" accept="video/*,image/*" class="border p-3 rounded">
                        <p class="text-xs text-gray-400">Supports MP4, WebM, PNG, JPG (Max 10MB recommended for sync speed)</p>
                        <button onclick="UI.handleUpload()" id="upBtn" class="bg-blue-600 text-white py-3 rounded font-bold">Upload to Global Feed</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-bold mb-4">Manage Global Content</h3>
                    <div class="space-y-4">
                        ${State.videos.map(v => `
                            <div class="flex items-center justify-between border-b pb-2">
                                <span>${v.title}</span>
                                <button onclick="UI.deleteVideo('${v.id}')" class="text-red-500 text-sm">Delete</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>`;
    },

    renderVideoCard(v) {
        // Detect if content is video or image
        const isVideo = v.url.includes('video/') || v.url.startsWith('data:video') || v.url.match(/\.(mp4|webm|mov|ogg)$/i);
        
        return `
        <div class="video-card bg-white rounded-2xl shadow-lg overflow-hidden transition-transform hover:scale-[1.02]">
            <div class="aspect-video bg-black relative group">
                ${isVideo ? 
                    `<video src="${v.url}" class="w-full h-full" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>` : 
                    `<img src="${v.url}" class="w-full h-full object-cover">`
                }
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                    <button onclick="UI.openPlayer('${v.id}')" class="bg-white text-black px-6 py-2 rounded-full font-bold">Watch Full</button>
                </div>
            </div>
            <div class="p-4">
                <h3 class="font-bold text-lg truncate">${v.title}</h3>
                <p class="text-gray-400 text-sm">Shared globally</p>
            </div>
        </div>`;
    },

    async handleUpload() {
        const title = document.getElementById('newTitle').value;
        const file = document.getElementById('newFile').files[0];
        const btn = document.getElementById('upBtn');

        if(!title || !file) return alert("Please provide title and file");

        btn.disabled = true;
        btn.innerText = "Processing & Syncing...";

        const reader = new FileReader();
        reader.onload = () => {
            const base64 = reader.result;
            const id = Math.random().toString(36).substr(2, 9);
            videoDB.get(id).put({
                title: title,
                url: base64,
                timestamp: Date.now()
            });
            btn.disabled = false;
            btn.innerText = "Upload to Global Feed";
            alert("Uploaded! Everyone can see it now.");
            UI.render();
        };
        reader.readAsDataURL(file);
    },

    deleteVideo(id) {
        if(confirm("Delete for everyone?")) {
            videoDB.get(id).put(null);
        }
    },

    openPlayer(id) {
        const v = State.videos.find(item => item.id === id);
        const isVideo = v.url.includes('video/') || v.url.startsWith('data:video');
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="relative w-full max-w-5xl bg-black rounded-2xl overflow-hidden shadow-2xl">
                <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 text-white bg-black/50 w-10 h-10 rounded-full z-10">âœ•</button>
                ${isVideo ? 
                    `<video src="${v.url}" controls autoplay class="w-full"></video>` : 
                    `<img src="${v.url}" class="w-full h-full">`
                }
                <div class="p-6 bg-white">
                    <h2 class="text-2xl font-bold">${v.title}</h2>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
};

// Initialize App
State.init();
</script>
</body>
</html>
