<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Video CMS</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }
    
    .video-card video { width: 100%; height: 100%; object-fit: cover; }
    .modal-backdrop { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
    
    /* Loading Animation */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #6366f1;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div id="app">
    <div class="min-h-screen flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-slate-500 font-medium animate-pulse">Connecting to Global Feed...</p>
    </div>
</div>

<script>
// --- GLOBAL DATABASE CONFIG ---
// We use multiple relay peers to ensure if one is down, the site still works.
const gun = Gun([
    'https://gun-manhattan.herokuapp.com/gun',
    'https://peer.wall.org/gun',
    'https://gundb-relay.herokuapp.com/gun'
]);

const videoDB = gun.get('ultimate_cms_v5_videos');
const categoryDB = gun.get('ultimate_cms_v5_cats');
const presenceDB = gun.get('ultimate_cms_v5_presence');

const State = {
    isAdmin: false,
    currentView: 'public',
    videos: [],
    categories: [],
    tags: [],
    liveUsers: 1,
    filterCat: 'all',
    filterTag: 'all',
    myId: Math.random().toString(36).substr(2, 9),
    dbConnected: false,

    init() {
        // 1. Sync Categories
        categoryDB.map().on((name, id) => {
            if (name) {
                const idx = this.categories.findIndex(c => c.id === id);
                if (idx > -1) this.categories[idx].name = name;
                else this.categories.push({ id, name });
            } else {
                this.categories = this.categories.filter(c => c.id !== id);
            }
            this.dbConnected = true;
            UI.render();
        });

        // 2. Sync Videos
        videoDB.map().on((data, id) => {
            if (data) {
                const processed = { 
                    ...data, 
                    id, 
                    tags: data.tags ? data.tags.split(',').map(t => t.trim()) : [] 
                };
                const index = this.videos.findIndex(v => v.id === id);
                if (index > -1) this.videos[index] = processed;
                else this.videos.push(processed);
                this.updateGlobalTags();
            } else {
                this.videos = this.videos.filter(v => v.id !== id);
            }
            this.dbConnected = true;
            UI.render();
        });

        // 3. Presence Logic (Live Count)
        setInterval(() => presenceDB.get(this.myId).put(Date.now()), 5000);
        presenceDB.map().on((time, id) => {
            if (Date.now() - time > 15000) presenceDB.get(id).put(null);
            this.updateCounter();
        });

        // Safety timeout: If DB takes too long, render anyway
        setTimeout(() => { if(!this.dbConnected) UI.render(); }, 3000);
    },

    updateGlobalTags() {
        const all = new Set();
        this.videos.forEach(v => v.tags.forEach(t => { if(t) all.add(t) }));
        this.tags = Array.from(all);
    },

    updateCounter() {
        presenceDB.once(data => {
            if (data) {
                const active = Object.values(data).filter(t => t && (Date.now() - t < 15000));
                this.liveUsers = active.length || 1;
                const el = document.getElementById('liveCounter');
                if (el) el.innerText = this.liveUsers;
            }
        });
    }
};

const UI = {
    render() {
        const app = document.getElementById('app');
        if (State.currentView === 'login') app.innerHTML = this.renderLogin();
        else if (State.currentView === 'admin') app.innerHTML = this.renderAdmin();
        else app.innerHTML = this.renderPublic();
    },

    renderLogin() {
        return `
        <div class="min-h-screen flex items-center justify-center p-6 bg-slate-100">
            <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-slate-200">
                <div class="w-16 h-16 bg-indigo-600 rounded-2xl mb-6 mx-auto flex items-center justify-center shadow-lg shadow-indigo-200">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-center">Admin Access</h2>
                <p class="text-slate-400 text-sm text-center mb-6">Enter your secret code</p>
                <input type="password" id="adminPass" class="w-full border border-slate-200 p-4 rounded-xl mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                <button onclick="UI.handleLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 transition-all">Login</button>
                <button onclick="State.currentView='public';UI.render()" class="w-full mt-4 text-slate-400 text-sm font-medium">Cancel</button>
            </div>
        </div>`;
    },

    handleLogin() {
        if (document.getElementById('adminPass').value === 'ilovegoon') {
            State.isAdmin = true; State.currentView = 'admin'; UI.render();
        } else alert('Incorrect Code');
    },

    renderPublic() {
        let filtered = State.videos;
        if (State.filterCat !== 'all') filtered = filtered.filter(v => v.category === State.filterCat);
        if (State.filterTag !== 'all') filtered = filtered.filter(v => v.tags.includes(State.filterTag));

        return `
        <nav class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black text-indigo-600 tracking-tight">VIDEO.STREAM</h1>
                    <div class="flex items-center gap-2 text-[10px] font-bold text-rose-500 uppercase mt-1">
                        <span class="w-2 h-2 bg-rose-500 rounded-full animate-pulse"></span>
                        <span id="liveCounter">${State.liveUsers}</span> Online Now
                    </div>
                </div>
                <button onclick="State.currentView='login';UI.render()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-indigo-50 hover:text-indigo-600 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
            </div>
        </nav>

        <div class="bg-white border-b border-slate-200 p-2 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <div class="max-w-7xl mx-auto flex gap-2">
                <button onclick="State.filterCat='all';UI.render()" class="px-5 py-2 rounded-xl text-sm font-bold transition-all ${State.filterCat === 'all' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-100'}">All</button>
                ${State.categories.map(c => `
                    <button onclick="State.filterCat='${c.id}';UI.render()" class="px-5 py-2 rounded-xl text-sm font-bold transition-all ${State.filterCat === c.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-100'}">${c.name}</button>
                `).join('')}
            </div>
        </div>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="flex flex-wrap gap-2 mb-8">
                ${State.tags.map(t => `<span onclick="State.filterTag='${t}';UI.render()" class="px-3 py-1 bg-white border border-slate-200 text-slate-500 rounded-lg text-xs font-bold cursor-pointer hover:border-indigo-500 hover:text-indigo-500 ${State.filterTag === t ? 'border-indigo-500 text-indigo-500 bg-indigo-50' : ''}">#${t}</span>`).join('')}
                ${State.filterTag !== 'all' ? `<button onclick="State.filterTag='all';UI.render()" class="text-xs text-rose-500 font-bold ml-2 underline">Clear Tags</button>` : ''}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                ${filtered.length === 0 ? '<div class="col-span-full py-20 text-center text-slate-400 font-medium">No videos found. Check back later!</div>' : ''}
                ${filtered.sort((a,b)=>b.time-a.time).map(v => this.renderCard(v)).join('')}
            </div>
        </main>`;
    },

    renderAdmin() {
        return `
        <div class="min-h-screen bg-slate-50">
            <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-xl">
                <h2 class="font-black tracking-widest text-sm uppercase">Power Dashboard</h2>
                <button onclick="State.currentView='public';UI.render()" class="bg-white/10 px-4 py-2 rounded-lg text-xs font-bold hover:bg-white/20 transition-all">Exit Admin</button>
            </header>

            <div class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5 space-y-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center text-sm">1</span>
                            Upload New Media
                        </h3>
                        <div class="space-y-4">
                            <input id="upTitle" placeholder="Video Title" class="w-full border border-slate-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                            
                            <select id="upCat" class="w-full border border-slate-200 p-3 rounded-xl outline-none">
                                <option value="">Select Category</option>
                                ${State.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>

                            <input id="upTags" placeholder="Tags (e.g. funny, movie, tech)" class="w-full border border-slate-200 p-3 rounded-xl outline-none">
                            
                            <div class="p-4 bg-slate-50 rounded-2xl border border-dashed border-slate-300">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Video Source</p>
                                <input type="file" id="upFile" accept="video/*" class="text-xs block w-full">
                                <p class="text-[9px] text-rose-400 font-bold mt-2 uppercase">Max 10MB for Global Sync</p>
                            </div>

                            <div class="p-4 bg-slate-50 rounded-2xl border border-dashed border-slate-300">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Thumbnail (Optional)</p>
                                <input type="file" id="upThumb" accept="image/*" class="text-xs block w-full">
                            </div>

                            <button onclick="UI.upload()" id="upBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">Publish Globally</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center text-sm">2</span>
                            Categories
                        </h3>
                        <div class="flex gap-2 mb-4">
                            <input id="newCatName" placeholder="New Category..." class="flex-1 border border-slate-200 p-2 rounded-xl text-sm">
                            <button onclick="UI.addCategory()" class="bg-emerald-500 text-white px-4 rounded-xl font-bold">+</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${State.categories.map(c => `<span class="bg-slate-100 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-2">${c.name} <button onclick="UI.delCategory('${c.id}')" class="text-rose-500 hover:scale-125 transition-all">âœ•</button></span>`).join('')}
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-7">
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold">Live Content (${State.videos.length})</h3>
                        </div>
                        <div class="divide-y divide-slate-100 max-h-[600px] overflow-y-auto">
                            ${State.videos.length === 0 ? '<p class="p-10 text-center text-slate-400 italic">No global content yet.</p>' : ''}
                            ${State.videos.map(v => `
                                <div class="p-4 flex items-center justify-between hover:bg-slate-50 transition-all">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 bg-slate-200 rounded-lg overflow-hidden flex-shrink-0">
                                            ${v.thumb ? `<img src="${v.thumb}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-xs">ðŸŽ¬</div>'}
                                        </div>
                                        <div>
                                            <p class="font-bold text-sm">${v.title}</p>
                                            <p class="text-[10px] text-slate-400 uppercase font-black">${State.categories.find(c=>c.id===v.category)?.name || 'Misc'}</p>
                                        </div>
                                    </div>
                                    <button onclick="UI.deleteVideo('${v.id}')" class="text-rose-500 font-bold text-xs uppercase p-2 hover:bg-rose-50 rounded-lg">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    },

    renderCard(v) {
        const categoryName = State.categories.find(c => c.id === v.category)?.name || 'Uncategorized';
        return `
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden group hover:shadow-2xl hover:shadow-indigo-100 transition-all duration-500">
            <div onclick="UI.play('${v.id}')" class="aspect-video bg-slate-900 relative cursor-pointer overflow-hidden">
                ${v.thumb ? 
                    `<img src="${v.thumb}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">` : 
                    `<video src="${v.url}" class="w-full h-full object-cover" muted></video>`
                }
                <div class="absolute inset-0 bg-indigo-900/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all duration-500">
                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-2xl scale-75 group-hover:scale-100 transition-all duration-500">
                        <svg class="w-6 h-6 text-indigo-600 ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3.5l11 6.5-11 6.5V3.5z"/></svg>
                    </div>
                </div>
                <div class="absolute bottom-3 left-3 px-2 py-1 bg-black/50 backdrop-blur-md rounded-lg text-[10px] font-black text-white uppercase tracking-widest">
                    ${categoryName}
                </div>
            </div>
            <div class="p-6">
                <h3 class="font-bold text-lg text-slate-800 truncate mb-2">${v.title}</h3>
                <div class="flex flex-wrap gap-1">
                    ${v.tags.map(t => `<span class="text-[10px] font-bold text-slate-400">#${t}</span>`).join(' ')}
                </div>
            </div>
        </div>`;
    },

    async upload() {
        const title = document.getElementById('upTitle').value;
        const cat = document.getElementById('upCat').value;
        const tags = document.getElementById('upTags').value;
        const vFile = document.getElementById('upFile').files[0];
        const tFile = document.getElementById('upThumb').files[0];
        const btn = document.getElementById('upBtn');

        if (!title || !vFile) return alert("Title and Video are required!");
        
        btn.disabled = true;
        btn.innerText = "Encoding for Global Sync...";

        const read = (f) => new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); });
        
        try {
            const vData = await read(vFile);
            const tData = tFile ? await read(tFile) : null;

            // Push to Global Gun DB
            const videoId = Math.random().toString(36).substr(2, 9);
            videoDB.get(videoId).put({
                title, 
                category: cat, 
                tags: tags, 
                url: vData, 
                thumb: tData, 
                time: Date.now()
            });
            
            alert("Success! Your video is now live for everyone.");
            btn.disabled = false;
            btn.innerText = "Publish Globally";
            UI.render();
        } catch (e) {
            alert("Upload failed. File might be too large.");
            btn.disabled = false;
            btn.innerText = "Publish Globally";
        }
    },

    addCategory() {
        const name = document.getElementById('newCatName').value;
        if (name) categoryDB.get(Math.random().toString(36).substr(2, 9)).put(name);
        document.getElementById('newCatName').value = '';
    },

    delCategory(id) { if (confirm("Delete Category?")) categoryDB.get(id).put(null); },
    deleteVideo(id) { if (confirm("Delete for everyone?")) videoDB.get(id).put(null); },

    play(id) {
        const v = State.videos.find(x => x.id === id);
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        modal.innerHTML = `
            <div class="relative w-full max-w-5xl bg-black rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/10">
                <button onclick="this.closest('.fixed').remove()" class="absolute top-6 right-6 text-white bg-white/10 hover:bg-rose-500 w-12 h-12 rounded-full z-10 transition-all">âœ•</button>
                <video src="${v.url}" controls autoplay class="w-full aspect-video"></video>
                <div class="p-8 bg-white">
                    <h2 class="text-2xl font-black text-slate-800">${v.title}</h2>
                    <p class="text-slate-400 text-sm mt-1 uppercase font-bold tracking-widest">${State.categories.find(c=>c.id===v.category)?.name || 'General'}</p>
                </div>
            </div>`;
        document.body.appendChild(modal);
    }
};

// Start the app
State.init();
</script>
</body>
</html>
